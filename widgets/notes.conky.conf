--[[
  ${CONKY_SUITE_DIR:-~/.config/conky/gtex62-tech-hud}/widgets/notes.conky.conf
  Scrolling "sticky notes" widget

  • Uses theme.lua for notes-specific knobs (notes.font, notes.wrap, notes.lines, notes.line_px, notes.text_x, notes.text_y).
  • Uses ${CONKY_SUITE_DIR}/lua/widgets/notes.lua for the panel background.
  • Reads from ~/Documents/conky-notes-tech.txt and displays the first N wrapped lines.
  • scripts/notes_wrap.sh uses fold(1)/sed(1)/awk(1) for wrapping + line limiting.
]]
-- Uses shared theme.lua for fonts/colors/layout
local HOME       = os.getenv("HOME") or ""
local SUITE_DIR  = os.getenv("CONKY_SUITE_DIR") or (HOME .. "/.config/conky/gtex62-tech-hud")
local THEME_PATH = os.getenv("CONKY_THEME_PATH") or (SUITE_DIR .. "/theme.lua")
local theme      = dofile(THEME_PATH)
local notes      = theme.notes or {}
local pos        = theme.layout_pos("notes")

local function scale_num(v)
  local n = tonumber(v)
  if n == nil then return nil end
  local s = tonumber(theme.scale) or 1.0
  return math.floor((n * s) + 0.5)
end

local function scale_font(spec)
  if type(spec) ~= "string" then return spec end
  local s = tonumber(theme.scale) or 1.0
  local raw = spec:match("size%s*=%s*([%d%.]+)")
  if not raw then return spec end
  local n = tonumber(raw)
  if not n then return spec end
  local scaled = math.max(1, math.floor((n * s) + 0.5))
  return spec:gsub("size%s*=%s*[%d%.]+", "size=" .. tostring(scaled), 1)
end

local function color_to_hex(c)
  if type(c) == "table" then
    local r = math.floor((c[1] or 1) * 255 + 0.5)
    local g = math.floor((c[2] or 1) * 255 + 0.5)
    local b = math.floor((c[3] or 1) * 255 + 0.5)
    return string.format("%02X%02X%02X", r, g, b)
  end
  if type(c) == "string" then
    local s = c:gsub("#", "")
    if s:match("^%x%x%x%x%x%x$") then return s end
  end
  return nil
end

local font_notes = scale_font(notes.font)
local text_color = color_to_hex(notes.text_color)
    or color_to_hex(theme.default_color)
    or "C0C0C0"
local text_alpha = notes.text_alpha
if text_alpha == nil and type(notes.text_color) == "table" and notes.text_color[4] then
  text_alpha = notes.text_color[4]
end
if text_alpha == nil then text_alpha = 1.0 end
if text_alpha < 0 then text_alpha = 0 end
if text_alpha > 1 then text_alpha = 1 end
local color_default = text_color
local color_label   = text_color
local notes_wrap    = notes.wrap
local notes_lines   = notes.lines
local notes_line_px = notes.line_px
local text_x        = scale_num(notes.text_x) or 0
local text_y        = scale_num(notes.text_y) or 0

conky.config        = {
  alignment              = 'top_left',
  xinerama_head          = theme.monitor_head,
  background             = false,
  double_buffer          = true,
  update_interval        = 1,

  use_xft                = true,
  xftalpha               = text_alpha,
  font                   = font_notes,

  own_window             = true,
  own_window_type        = 'desktop', -- was 'dock'
  own_window_hints       = 'undecorated,sticky,skip_taskbar,skip_pager,below',
  own_window_argb_visual = true,
  own_window_argb_value  = 0,
  own_window_transparent = true,
  own_window_class       = 'Conky',
  -- optional but nice:
  -- own_window_title = 'conky-<name>',  -- e.g., conky-net, conky-notes


  minimum_width     = theme.layout_dim("notes", "min_w", 360),
  maximum_width     = theme.layout_dim("notes", "max_w", 360),
  minimum_height    = theme.layout_dim("notes", "min_h", 700),
  text_buffer_size  = 24576,

  -- keep your placement
  gap_x             = pos.x,
  gap_y             = pos.y,

  draw_shades       = false,
  draw_borders      = false,
  default_color     = color_default,
  color1            = color_label,

  lua_load          = SUITE_DIR .. "/lua/widgets/notes.lua",
  lua_draw_hook_pre = 'draw_notes_panel',

}

-- Reads the first N wrapped lines from your notes file:
--   $HOME/Documents/conky-notes-tech.txt
conky.text          = [[
${color ]] .. text_color .. [[}${voffset ]] .. text_y .. [[}${execpi 3 ]] ..
    SUITE_DIR .. [[/scripts/notes_wrap.sh ]] .. notes_wrap .. [[ ]] ..
    notes_lines .. [[ ]] .. text_x .. [[}
]]
