--[[
  ${CONKY_SUITE_DIR:-~/.config/conky/gtex62-tech-hud}/widgets/doctor.conky.conf
  Diagnostics widget (suite + cache + dependency checks)
]]
local HOME       = os.getenv("HOME") or ""
local SUITE_DIR  = os.getenv("CONKY_SUITE_DIR") or (HOME .. "/.config/conky/gtex62-tech-hud")
local THEME_PATH = os.getenv("CONKY_THEME_PATH") or (SUITE_DIR .. "/theme.lua")
local theme      = dofile(THEME_PATH)
local pos        = theme.layout_pos("doctor")

local function color_to_hex(c)
  if type(c) == "table" then
    local r = math.floor((c[1] or 1) * 255 + 0.5)
    local g = math.floor((c[2] or 1) * 255 + 0.5)
    local b = math.floor((c[3] or 1) * 255 + 0.5)
    return string.format("%02X%02X%02X", r, g, b)
  end
  if type(c) == "string" then
    local s = c:gsub("#", "")
    if s:match("^%x%x%x%x%x%x$") then return s end
  end
  return nil
end

local fonts = theme.fonts or {}
local font_doctor = (fonts.value_mono or "monospace") .. ":size=9"
local text_color = color_to_hex(theme.default_color) or "C0C0C0"
local text_alpha = 0.85

conky.config = {
  alignment              = 'top_left',
  xinerama_head          = theme.monitor_head,
  background             = false,
  double_buffer          = true,
  update_interval        = 1,

  use_xft                = true,
  xftalpha               = text_alpha,
  font                   = font_doctor,

  own_window             = true,
  own_window_type        = 'desktop',
  own_window_hints       = 'undecorated,sticky,skip_taskbar,skip_pager,below',
  own_window_argb_visual = true,
  own_window_argb_value  = 0,
  own_window_transparent = true,
  own_window_class       = 'Conky',

  minimum_width          = theme.layout_dim("doctor", "min_w", 520),
  maximum_width          = theme.layout_dim("doctor", "max_w", 520),
  minimum_height         = theme.layout_dim("doctor", "min_h", 600),
  text_buffer_size       = 8192,

  gap_x                  = pos.x,
  gap_y                  = pos.y,

  draw_shades            = false,
  draw_borders           = false,
  default_color          = text_color,
}

conky.text = [[
${color ]] .. text_color .. [[}${execpi 60 ]] .. SUITE_DIR .. [[/scripts/doctor.sh}
]]
